<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>リモートワーク管理カレンダー</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <style>
    :root { 
      --c-bg: #f5f7fa; 
      --c-work: #fff; 
      --c-remote: #e3f2fd; 
      --c-sat: #e8f5e9; 
      --c-sun: #ffebee; 
      --c-hol: #ffcdd2; 
      --c-paid: #fff9c4; 
      --c-paid-sudden: #fff3e0; 
      --c-text: #333; 
      --c-select: #1976d2;
      --c-my-holiday: #e0f2f1;
      --c-accent: #009688;
      --sidebar-width: 300px;
    }
    
    body { 
      font-family: 'Noto Sans JP', sans-serif; 
      background: var(--c-bg); 
      color: var(--c-text); 
      margin: 0; 
      padding: 0; 
      height: 100vh; 
      height: 100dvh; 
      overflow: hidden; 
    }
    
    #app {
      display: flex;
      height: 100%;
      width: 100%;
    }

    /* --- Sidebar --- */
    .sidebar {
      flex: 0 0 var(--sidebar-width);
      min-width: 280px;
      background: white;
      border-right: 1px solid #ddd;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
      z-index: 10;
    }

    .main-content {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow: hidden; 
      min-width: 0;
    }

    /* UI Components */
    .mode-switch {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 8px;
      transition: background 0.3s;
    }
    .mode-switch.active-mode { background: var(--c-select); color: white; }
    .mode-switch.active-mode-holiday { background: var(--c-accent); color: white; }
    
    .switch-label { font-weight: bold; font-size: 0.9em; }
    .toggle-input { display: none; }
    .toggle-btn {
      position: relative; width: 40px; height: 20px;
      background: #ccc; border-radius: 20px; cursor: pointer; transition: 0.3s;
    }
    .toggle-btn::after {
      content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px;
      background: white; border-radius: 50%; transition: 0.3s;
    }
    .toggle-input:checked + .toggle-btn { background: var(--c-select); }
    .toggle-input:checked + .toggle-btn::after { transform: translateX(20px); }
    .toggle-input.holiday-toggle:checked + .toggle-btn { background: var(--c-accent); }

    .bulk-actions, .instruction-panel {
      background: #e3f2fd; border: 1px solid #90caf9; padding: 15px; border-radius: 8px;
      animation: fadeIn 0.3s;
    }
    .instruction-panel { background: #e0f2f1; border-color: #80cbc4; color: #00695c; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .bulk-info { font-weight: bold; margin-bottom: 10px; text-align: center; }
    .bulk-btn-group { display: flex; gap: 5px; flex-direction: column; }
    .btn-primary { background: var(--c-select); color: white; width: 100%; padding: 8px; border:none; border-radius:4px; cursor:pointer;}
    .btn-outline { background: transparent; border: 1px solid #666; color: #666; width: 100%; padding: 8px; border-radius:4px; cursor:pointer;}

    /* Dashboard Stats */
    .dashboard { display: flex; flex-direction: column; gap: 15px; }
    .card { 
      background: #f9f9f9; padding: 15px; border-radius: 8px; 
      border: 1px solid #eee; text-align: center; 
    }
    .card h3 { margin: 0 0 5px 0; font-size: 0.85em; color: #666; }
    .card .val { font-size: 1.4em; font-weight: bold; }
    .card.alert .val { color: #d32f2f; }
    .card.safe .val { color: #2e7d32; }

    /* Calendar Parts */
    .calendar-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; background: white; padding: 10px 20px;
      border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0;
    }
    .current-month { font-size: 1.5em; font-weight: bold; margin: 0; }
    button.nav-btn { cursor: pointer; padding: 8px 16px; border: none; background: #333; color: white; border-radius: 4px; }

    /* Calendar Grid */
    .calendar-container {
      flex: 1; display: flex; flex-direction: column; overflow: hidden;
      border: 1px solid #ddd; background: #ccc; 
    }
    .calendar-grid { 
      display: grid; 
      grid-template-columns: repeat(7, minmax(0, 1fr)); 
      grid-template-rows: 40px repeat(6, 1fr); 
      gap: 1px; background: #ccc; height: 100%; width: 100%;
    }

    .header-cell { 
      background: #333; color: white; font-weight: bold; 
      display: flex; align-items: center; justify-content: center; height: 100%; 
    }
    .day-cell { 
      background: var(--c-work); padding: 5px; position: relative; 
      cursor: pointer; transition: 0.1s; display: flex; flex-direction: column; min-height: 0;
      overflow: hidden; 
    }
    .day-cell:hover { filter: brightness(0.95); }
    
    /* Selection / Interaction Styles */
    .day-cell.is-selected { background: #e3f2fd !important; box-shadow: inset 0 0 0 3px var(--c-select); }
    .day-cell.is-selected .date-num { color: var(--c-select); font-weight: 900; }
    .day-cell.is-swap-source { background: #b2dfdb !important; box-shadow: inset 0 0 0 3px var(--c-accent); animation: pulse 1.5s infinite; }
    .day-cell.can-be-source { cursor: pointer; }
    .day-cell.cannot-select { opacity: 0.4; cursor: not-allowed; }
    @keyframes pulse {
      0% { box-shadow: inset 0 0 0 3px var(--c-accent); }
      50% { box-shadow: inset 0 0 0 6px rgba(0, 150, 136, 0.3); }
      100% { box-shadow: inset 0 0 0 3px var(--c-accent); }
    }

    /* Day Status Styles */
    .day-cell:not(.is-selected):not(.is-swap-source).is-remote { background: var(--c-remote); border-left: 5px solid #2196f3; }
    .day-cell:not(.is-selected):not(.is-swap-source).is-paid-planned { background: var(--c-paid); border-left: 5px solid #fbc02d; }
    .day-cell:not(.is-selected):not(.is-swap-source).is-paid-sudden { background: var(--c-paid-sudden); border-left: 5px solid #ff9800; }
    .day-cell:not(.is-selected):not(.is-swap-source).is-half { background: linear-gradient(135deg, var(--c-paid) 50%, var(--c-work) 50%); border-left: 5px solid #fbc02d; }
    .day-cell:not(.is-selected):not(.is-swap-source).is-half-remote { background: linear-gradient(135deg, var(--c-paid) 50%, var(--c-remote) 50%); border-left: 5px solid #2196f3; }
    .day-cell:not(.is-selected):not(.is-swap-source).is-holiday { background: var(--c-hol); color: #b71c1c; }
    .day-cell:not(.is-selected):not(.is-swap-source).is-sat { background: var(--c-sat); color: #1b5e20; }
    .day-cell:not(.is-selected):not(.is-swap-source).is-sun { background: var(--c-sun); color: #b71c1c; }
    .day-cell:not(.is-selected):not(.is-swap-source).is-my-holiday { background: var(--c-my-holiday); color: #00695c; border-left: 5px solid var(--c-accent); }
    .day-cell:not(.is-selected):not(.is-swap-source).is-work-swap { background: #fff; color: #333; border-left: 5px solid #555; }
    .day-cell.is-other-month { background: #f0f0f0 !important; color: #aaa !important; pointer-events: none; }

    .date-num { font-weight: bold; margin-bottom: 2px; font-size: 0.9em; }
    
    .badge { 
      display: inline-block; 
      font-size: 0.65em; 
      padding: 1px 3px; 
      border-radius: 3px; 
      background: rgba(255,255,255,0.95); 
      border: 1px solid rgba(0,0,0,0.15); 
      margin-top: 1px;
      align-self: flex-start;
      white-space: normal; 
      word-break: break-all; 
      line-height: 1.1; 
      max-width: 100%; 
      color: #333;
    }

    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 100; }
    .modal { background: white; padding: 20px; border-radius: 8px; width: 340px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; }
    .status-group { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .group-label { font-size: 0.75em; color: #888; font-weight: bold; margin-bottom: 5px; }
    .status-btn { display: block; width: 100%; margin: 4px 0; padding: 8px; border: 1px solid #ccc; background: white; color: #333; text-align: left; cursor: pointer; border-radius: 4px; font-size: 0.9em;}
    .status-btn:hover { background: #f5f5f5; }
    .status-btn.active { background: #e3f2fd; border-color: #2196f3; font-weight: bold; color: #1565c0; }
    .custom-input-group { margin: 15px 0 5px 0; }
    .custom-input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; }
    .input-label { font-size: 0.8em; color: #666; display: block; margin-bottom: 3px; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    .btn-confirm { background: var(--c-select); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    .btn-cancel { background: #ccc; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; }
    .loading { position: fixed; top: 0; left: 0; right:0; bottom:0; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 200; flex-direction: column;}
    .error-msg { font-size: 0.9em; color: red; margin-top: 10px; }

    /* Smartphone Optimized */
    @media (max-width: 768px) {
      body { height: 100dvh; overflow: hidden; }
      #app { flexDirection: column; height: 100%; }
      .sidebar { flex: none; width: 100%; height: auto; padding: 5px 10px; border-right: none; border-bottom: 1px solid #ddd; gap: 5px; overflow-y: visible; flex-shrink: 0; }
      .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
      .card { padding: 4px; min-height: 48px; display: flex; flexDirection: column; justifyContent: center; alignItems: center; }
      .card h3 { fontSize: 0.6em; margin-bottom: 0; whiteSpace: nowrap; lineHeight: 1.2; }
      .card .val { fontSize: 1.0em; lineHeight: 1.2; }
      .mode-switch { padding: 4px 8px; min-height: 32px; }
      .switch-label { fontSize: 0.75em; }
      .toggle-btn { width: 32px; height: 16px; }
      .toggle-btn::after { width: 12px; height: 12px; top: 2px; left: 2px; }
      .toggle-input:checked + .toggle-btn::after { transform: translateX(16px); }
      .instruction-panel, .bulk-actions { padding: 5px; fontSize: 0.8em; }
      .bulk-info { margin-bottom: 2px; }
      .main-content { flex: 1; padding: 2px; height: 100%; display: flex; flexDirection: column; min-height: 0; }
      .calendar-header { padding: 4px 10px; margin-bottom: 2px; min-height: 30px; }
      .current-month { fontSize: 1.0em; }
      button.nav-btn { padding: 4px 8px; fontSize: 0.8em; }
      .calendar-container { border: none; height: 100%; aspectRatio: auto; flex: 1; }
      .calendar-grid { height: 100%; grid-template-rows: 24px repeat(6, 1fr); }
      .header-cell { fontSize: 0.75em; }
      .day-cell { padding: 1px; borderLeftWidth: 3px !important; }
      .date-num { fontSize: 0.75em; margin-bottom: 0; }
      .badge { fontSize: 0.55em; padding: 0 1px; margin-top: 0; transform: scale(0.95); transform-origin: top left; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div v-if="loading" class="loading">
      <div>データを読み込んでいます...</div>
      <div v-if="errorMsg" class="error-msg">{{ errorMsg }}</div>
    </div>

    <div class="sidebar">
      
      <div class="dashboard">
        <div class="card" :class="{ alert: stats.remainingRemote < 0, safe: stats.remainingRemote >= 0 }">
          <h3>リモート残</h3>
          <div class="val">{{ stats.remainingRemote }} <span style="font-size:0.7em; color:#999;">/{{ stats.remoteLimit }}</span></div>
        </div>
        <div class="card">
          <h3>母数</h3>
          <div class="val">{{ stats.workableDays }}</div>
        </div>
        <div class="card">
          <h3>有給</h3>
          <div class="val">{{ stats.paidLeave }}</div>
        </div>
        <div class="card">
          <h3>休日・祝</h3>
          <div class="val">{{ stats.holidays }}</div>
        </div>
        <div class="card">
          <h3>全日</h3>
          <div class="val">{{ stats.totalDays }}</div>
        </div>
         <div class="card" style="background:transparent; border:none; box-shadow:none; min-height:0;"></div>
      </div>

      <div class="mode-switch" :class="{ 'active-mode': isMultiSelectMode }">
        <span class="switch-label">複数選択モード</span>
        <label>
          <input type="checkbox" class="toggle-input" v-model="isMultiSelectMode" @change="onModeChange('multi')" :disabled="isMyHolidayMode">
          <div class="toggle-btn"></div>
        </label>
      </div>

      <div v-if="isMultiSelectMode" class="bulk-actions">
        <div class="bulk-info">{{ selectedDates.length }}日 選択中</div>
        <div class="bulk-btn-group">
          <button class="btn-primary" @click="openBulkModal" :disabled="selectedDates.length === 0">一括変更</button>
          <button class="btn-outline" @click="clearSelection" :disabled="selectedDates.length === 0">解除</button>
        </div>
      </div>

      <div class="mode-switch" :class="{ 'active-mode-holiday': isMyHolidayMode }">
        <span class="switch-label">マイホリデー指定</span>
        <label>
          <input type="checkbox" class="toggle-input holiday-toggle" v-model="isMyHolidayMode" @change="onModeChange('holiday')" :disabled="isMultiSelectMode">
          <div class="toggle-btn"></div>
        </label>
      </div>

      <div v-if="isMyHolidayMode" class="instruction-panel">
        <div v-if="!swapSourceDate" class="bulk-info" style="font-size:0.9em; text-align:left;">
          振替元の<br><strong>休日（祝日/休暇）</strong><br>を選択してください<br>
        </div>
        <div v-else class="bulk-info" style="font-size:0.9em; text-align:left;">
          <strong>{{ swapSourceDate.dateStr }}</strong> を振替えます。<br>
          対象の <strong>平日</strong> を選択してください。
          <button @click="swapSourceDate = null" style="margin-top:2px; font-size:0.8em; padding:1px 5px; cursor:pointer;">選択し直す</button>
        </div>
      </div>

    </div>

    <div class="main-content">
      <div class="calendar-header">
        <button class="nav-btn" @click="changeMonth(-1)"> &lt; </button>
        <div class="current-month">{{ year }}年 {{ month }}月</div>
        <button class="nav-btn" @click="changeMonth(1)"> &gt; </button>
      </div>

      <div class="calendar-container">
        <div class="calendar-grid">
          <div class="header-cell" v-for="d in ['日','月','火','水','木','金','土']" :key="d">{{ d }}</div>
          
          <div v-for="day in calendarDays" :key="day.dateStr" 
               class="day-cell" 
               :class="[getDayClass(day), getSelectionClass(day)]"
               @click="handleDayClick(day)">
            
            <span class="date-num">{{ day.date.getDate() }}</span>
            
            <div v-if="day.status === 'REMOTE'" class="badge" style="color:#1565c0">リモート</div>
            <div v-if="day.status === 'PAID_PLANNED'" class="badge" style="color:#f57f17">予定有給</div>
            <div v-if="day.status === 'PAID_SUDDEN'" class="badge" style="color:#ef6c00">当日有給</div>
            <div v-if="day.status.startsWith('PAID_AM') || day.status.startsWith('PAID_PM')" class="badge">半休</div>

            <div v-if="day.publicHolidayName && day.status === 'DEFAULT'" class="badge" style="background:#ffebee; color:#b71c1c;">{{ day.publicHolidayName }}</div>
            <div v-if="day.isCompanyHoliday && day.status === 'DEFAULT'" class="badge" style="background:#ffebee; color:#b71c1c;">会社休</div>
            <div v-if="day.status === 'HOLIDAY'" class="badge" style="background:#ffebee; color:#b71c1c;">{{ day.holidayLabel || '休日' }}</div>

            <div v-if="day.status === 'WORK' && (day.isWeekend || day.publicHolidayName || day.isCompanyHoliday)" class="badge" style="background:#333; color:#fff;">出勤</div>

            <div v-if="day.status === 'MY_HOLIDAY'" class="badge" style="background:var(--c-accent); color:white;">
              My休
            </div>
            <div v-if="day.status === 'MY_HOLIDAY' && day.holidayLabel" class="badge" style="font-size:0.5em; border:none; background:transparent;">
              (元:{{ day.holidayLabel.slice(5) }})
            </div>

            <div v-if="day.status === 'WORK_SWAP'" class="badge" style="background:#333; color:#fff;">
              振替出勤
            </div>
            <div v-if="day.status === 'WORK_SWAP' && day.holidayLabel" class="badge" style="font-size:0.5em; border:none; background:transparent;">
              (先:{{ day.holidayLabel.slice(5) }})
            </div>

          </div>
        </div>
      </div>
    </div>

    <div v-if="showModal" class="modal-overlay" @click.self="closeModal">
      <div class="modal">
        <h3 v-if="isBulkEdit">{{ selectedDates.length }}件 を一括設定</h3>
        <h3 v-else>{{ selectedDay.dateStr }} の設定</h3>
        
        <p v-if="!isBulkEdit" style="font-size:0.8em; color:#666; margin-bottom:10px;">
          元の属性: {{ getOriginalType(selectedDay) }}
        </p>
        
        <div class="status-group">
          <div class="group-label">基本</div>
          <button class="status-btn" @click="setStatus('DEFAULT')">標準に戻す</button>
          <button class="status-btn" @click="setStatus('WORK')">出社 (WORK)</button>
          <button class="status-btn" @click="setStatus('REMOTE')">リモート (REMOTE)</button>
        </div>

        <div class="status-group">
          <div class="group-label">有給</div>
          <button class="status-btn" @click="setStatus('PAID_PLANNED')">予定有給 (母数減)</button>
          <button class="status-btn" @click="setStatus('PAID_SUDDEN')">当日有給 (母数維持)</button>
        </div>

        <div class="status-group">
           <div class="group-label">休日設定</div>
           <div class="custom-input-group" style="margin-top:0;">
             <input type="text" v-model="holidayLabelInput" class="custom-input" placeholder="名称(例:夏季休暇)">
           </div>
           <button class="status-btn" @click="setStatus('HOLIDAY')">強制休暇として設定</button>
        </div>
        
        <div style="text-align:right; margin-top:10px;">
          <button class="btn-cancel" @click="closeModal">閉じる</button>
        </div>
      </div>
    </div>

    <div v-if="showSwapConfirmModal" class="modal-overlay" @click.self="showSwapConfirmModal = false">
      <div class="modal">
        <h3>マイホリデー振替の確認</h3>
        <div style="margin: 20px 0; text-align: center;">
            <div style="font-size:0.9em; color:#666;">元の日付（出勤日になります）</div>
            <div style="font-weight:bold; font-size:1.2em; color:#b71c1c;">{{ swapSourceDate?.dateStr }}</div>
            <div style="margin:5px 0;">⇅ 入れ替え ⇅</div>
            <div style="font-size:0.9em; color:#666;">先の日付（マイホリデーになります）</div>
            <div style="font-weight:bold; font-size:1.2em; color:var(--c-accent);">{{ swapTargetDate?.dateStr }}</div>
        </div>
        <p style="font-size:0.8em; color:#666;">
            ※選択された休日は出勤日扱いとなり、選択された平日はマイホリデー（休日）となります。
        </p>
        <div class="modal-actions">
            <button class="btn-cancel" @click="showSwapConfirmModal = false">キャンセル</button>
            <button class="btn-confirm" @click="executeSwap">入れ替える</button>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { createApp, ref, computed, onMounted } from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.esm-browser.prod.min.js";

    // ユーザー提供のFirebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyDUSF9MllpVWb1Ewn4u4DIlXnFiUdNnPMg",
      authDomain: "remote-calendar-cb47f.firebaseapp.com",
      projectId: "remote-calendar-cb47f",
      storageBucket: "remote-calendar-cb47f.firebasestorage.app",
      messagingSenderId: "527643294363",
      appId: "1:527643294363:web:7dba7358decee61555243e",
      measurementId: "G-NPBHTR94SJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Collection Names
    const COL_DATA = "calendar_data";
    const COL_CONFIG = "company_holidays";

    createApp({
      setup() {
        const loading = ref(true);
        const errorMsg = ref('');
        const year = ref(new Date().getFullYear());
        const month = ref(new Date().getMonth() + 1);
        
        const dbData = ref({});
        const companyHolidays = ref({});
        const publicHolidays = ref({});

        // Modes
        const isMultiSelectMode = ref(false);
        const isMyHolidayMode = ref(false);

        // Selection State
        const selectedDates = ref([]);
        const showModal = ref(false);
        const selectedDay = ref(null);
        const isBulkEdit = ref(false);
        const holidayLabelInput = ref('');

        // My Holiday Swap State
        const swapSourceDate = ref(null); 
        const swapTargetDate = ref(null); 
        const showSwapConfirmModal = ref(false);

        // ------------------------------------------------
        // Data Fetching (Replaces GAS getInitialData)
        // ------------------------------------------------
        const loadAllData = async () => {
          loading.value = true;
          errorMsg.value = '';
          
          try {
            // 1. Fetch Status Data from Firestore
            const querySnapshot = await getDocs(collection(db, COL_DATA));
            const loadedData = {};
            querySnapshot.forEach((doc) => {
              loadedData[doc.id] = doc.data().status;
            });
            dbData.value = loadedData;

            // 2. Fetch Company Holidays from Firestore
            const configSnapshot = await getDocs(collection(db, COL_CONFIG));
            const loadedConfig = {};
            configSnapshot.forEach((doc) => {
              loadedConfig[doc.id] = true;
            });
            companyHolidays.value = loadedConfig;

            // 3. Fetch Public Holidays (Using an Open API + Filtering)
            await fetchPublicHolidays();

            loading.value = false;

          } catch (e) {
            console.error(e);
            errorMsg.value = "読み込みエラー: " + e.message;
            loading.value = false;
          }
        };

        const fetchPublicHolidays = async () => {
           // Using a reliable JSON source for JP holidays
           try {
             const res = await fetch('https://holidays-jp.github.io/api/v1/date.json');
             const allHolidays = await res.json();
             
             // GAS Logic: Filtering specific keywords
             const ignoreKeywords = [
                '節分', '七夕', 'ハロウィン', 'クリスマス', 'イースター', 
                '母の日', '父の日', 'バレンタイン', 'ホワイトデー', 
                'ひな祭り', '雛祭り',
                '七五三', '銀行休業日', '立春', '夏至', '冬至', '八十八夜', 
                '入社式', '卒業式', 'エイプリルフール'
             ];
             
             const filtered = {};
             // The API key is YYYY-MM-DD, value is Title
             Object.keys(allHolidays).forEach(dateKey => {
               const title = allHolidays[dateKey];
               if (!ignoreKeywords.some(keyword => title.indexOf(keyword) !== -1)) {
                 filtered[dateKey] = title;
               }
             });
             publicHolidays.value = filtered;

           } catch(e) {
             console.warn("祝日データの取得に失敗しました", e);
           }
        };

        // ------------------------------------------------
        // Saving Data (Replaces GAS saveStatus/saveBulkStatus)
        // ------------------------------------------------
        const saveStatusToDb = async (dateStrList, status) => {
          try {
            const batch = writeBatch(db);
            
            dateStrList.forEach(dateStr => {
               const docRef = doc(db, COL_DATA, dateStr);
               if (status === 'DEFAULT') {
                 // Or deleteField() if you prefer to clean up
                 batch.delete(docRef);
               } else {
                 batch.set(docRef, { status: status });
               }
            });

            await batch.commit();
            console.log("Saved successfully");
          } catch(e) {
            console.error("Save Error", e);
            alert("保存に失敗しました: " + e.message);
          }
        };


        // --- Rest of the Logic (Identical to GAS version) ---

        const formatDate = (d) => {
          const y = d.getFullYear();
          const m = ('0' + (d.getMonth() + 1)).slice(-2);
          const day = ('0' + d.getDate()).slice(-2);
          return `${y}-${m}-${day}`;
        };

        const parseStatus = (raw) => {
          if (!raw) return { status: 'DEFAULT', label: '' };
          if (typeof raw === 'string') {
             if (raw.startsWith('HOLIDAY:')) return { status: 'HOLIDAY', label: raw.substring(8) };
             if (raw.startsWith('MY_HOLIDAY:')) return { status: 'MY_HOLIDAY', label: raw.substring(11) }; 
             if (raw.startsWith('WORK_SWAP:')) return { status: 'WORK_SWAP', label: raw.substring(10) }; 
          }
          return { status: raw, label: '' };
        };

        const calendarDays = computed(() => {
          if (loading.value && !errorMsg.value) return [];
          const days = [];
          const firstDateOfMonth = new Date(year.value, month.value - 1, 1);
          const dayOfWeek = firstDateOfMonth.getDay();
          const startDate = new Date(year.value, month.value - 1, 1 - dayOfWeek);
          
          for (let i = 0; i < 42; i++) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i);
            const dateStr = formatDate(d);
            const isTargetMonth = (d.getMonth() + 1) === month.value;
            
            const rawStatus = dbData.value[dateStr];
            const { status, label } = parseStatus(rawStatus);

            days.push({
              date: d,
              dateStr: dateStr,
              isOtherMonth: !isTargetMonth,
              dayOfWeek: d.getDay(),
              isWeekend: d.getDay() === 0 || d.getDay() === 6,
              publicHolidayName: publicHolidays.value[dateStr] || null,
              isCompanyHoliday: !!companyHolidays.value[dateStr],
              status: status || 'DEFAULT',
              holidayLabel: label
            });
          }
          return days;
        });

        const stats = computed(() => {
          let totalDays = 0, holidays = 0, paidLeave = 0, remoteUsage = 0;
          let workableDenominator = 0;

          calendarDays.value.forEach(day => {
            if (day.isOtherMonth) return;
            totalDays++;
            const s = day.status;
            
            const isDefaultHoliday = day.isWeekend || day.publicHolidayName || day.isCompanyHoliday;
            
            let type = 'WORK'; 
            if (s === 'DEFAULT') {
               if (isDefaultHoliday) type = 'HOLIDAY';
            } else if (s === 'HOLIDAY' || s === 'MY_HOLIDAY') {
               type = 'HOLIDAY';
            } else if (s === 'WORK_SWAP') {
               type = 'WORK';
            } else {
               type = s; 
            }

            if (type === 'HOLIDAY') {
              holidays++;
            } 
            else if (type === 'REMOTE') {
              remoteUsage += 1.0;
              workableDenominator += 1.0;
            }
            else if (type === 'WORK') {
              workableDenominator += 1.0;
            }
            else if (type === 'PAID_PLANNED') {
              paidLeave += 1.0;
            }
            else if (type === 'PAID_SUDDEN') {
              paidLeave += 1.0;
              workableDenominator += 1.0;
            }
            else if (type.startsWith('PAID_')) {
              paidLeave += 0.5;
              workableDenominator += 1.0; 
              if (type.includes('REMOTE')) remoteUsage += 1.0; 
            }
          });

          const remoteLimit = Math.ceil(workableDenominator / 2);
          
          return { 
            totalDays, holidays, paidLeave, workableDays: workableDenominator, 
            remoteLimit, usedRemote: remoteUsage, remainingRemote: remoteLimit - remoteUsage 
          };
        });

        const getDayClass = (day) => {
          if (day.isOtherMonth) return 'is-other-month';
          
          const s = day.status;
          if (s === 'MY_HOLIDAY') return 'is-my-holiday';
          if (s === 'WORK_SWAP') return 'is-work-swap';
          if (s === 'REMOTE') return 'is-remote';
          if (s === 'PAID_PLANNED') return 'is-paid-planned';
          if (s === 'PAID_SUDDEN') return 'is-paid-sudden';
          if (s === 'PAID_AM_REMOTE' || s === 'PAID_PM_REMOTE') return 'is-half-remote';
          if (s === 'PAID_AM_WORK' || s === 'PAID_PM_WORK') return 'is-half';
          if (s === 'WORK') return '';
          if (s === 'HOLIDAY') return 'is-holiday';
          
          if (day.publicHolidayName || day.isCompanyHoliday) return 'is-holiday';
          if (day.dayOfWeek === 0) return 'is-sun';
          if (day.dayOfWeek === 6) return 'is-sat';
          return '';
        };

        const getSelectionClass = (day) => {
            if (isMyHolidayMode.value) {
                if (swapSourceDate.value && swapSourceDate.value.dateStr === day.dateStr) {
                    return 'is-swap-source';
                }
                if (!swapSourceDate.value) {
                    const isCandidate = (day.status === 'HOLIDAY' || day.publicHolidayName || day.isCompanyHoliday) 
                                        && !day.isWeekend && day.status !== 'WORK_SWAP';
                    return isCandidate ? 'can-be-source' : 'cannot-select';
                }
                if (swapSourceDate.value) {
                     const isCandidate = !day.isWeekend && !day.publicHolidayName && !day.isCompanyHoliday 
                                         && day.status !== 'MY_HOLIDAY' && day.status !== 'PAID_PLANNED';
                     return isCandidate ? 'can-be-source' : 'cannot-select';
                }
            }
            if (selectedDates.value.includes(day.dateStr)) return 'is-selected';
            return '';
        };

        const changeMonth = (delta) => {
          let m = month.value + delta;
          let y = year.value;
          if (m > 12) { m = 1; y++; }
          if (m < 1) { m = 12; y--; }
          month.value = m;
          year.value = y;
          selectedDates.value = [];
          swapSourceDate.value = null;
        };

        const onModeChange = (type) => {
           if (type === 'multi') {
             if(isMultiSelectMode.value) isMyHolidayMode.value = false;
           } else {
             if(isMyHolidayMode.value) {
               isMultiSelectMode.value = false;
               selectedDates.value = [];
             }
             swapSourceDate.value = null;
           }
        };

        const handleDayClick = (day) => {
          if (day.isOtherMonth) return;
          
          if (isMyHolidayMode.value) {
            if (!swapSourceDate.value) {
                if (day.isWeekend) return; 
                if (day.status === 'HOLIDAY' || day.publicHolidayName || day.isCompanyHoliday) {
                    swapSourceDate.value = day;
                }
                return;
            }
            else {
                if (day.dateStr === swapSourceDate.value.dateStr) {
                    swapSourceDate.value = null;
                    return;
                }
                const isWeekday = !day.isWeekend && !day.publicHolidayName && !day.isCompanyHoliday;
                const isAvailable = day.status === 'DEFAULT' || day.status === 'WORK' || day.status === 'REMOTE';
                
                if (isWeekday && isAvailable) {
                    swapTargetDate.value = day;
                    showSwapConfirmModal.value = true;
                }
                return;
            }
          }

          if (isMultiSelectMode.value) {
            const idx = selectedDates.value.indexOf(day.dateStr);
            if (idx >= 0) {
              selectedDates.value.splice(idx, 1);
            } else {
              selectedDates.value.push(day.dateStr);
            }
            return;
          } 
          
          isBulkEdit.value = false;
          selectedDay.value = day;
          holidayLabelInput.value = day.holidayLabel || '';
          showModal.value = true;
        };

        const executeSwap = () => {
            if (!swapSourceDate.value || !swapTargetDate.value) return;

            const sourceStr = swapSourceDate.value.dateStr;
            const targetStr = swapTargetDate.value.dateStr;

            dbData.value[sourceStr] = 'WORK_SWAP:' + targetStr;
            dbData.value[targetStr] = 'MY_HOLIDAY:' + sourceStr;

            saveStatusToDb([sourceStr], 'WORK_SWAP:' + targetStr);
            saveStatusToDb([targetStr], 'MY_HOLIDAY:' + sourceStr);

            showSwapConfirmModal.value = false;
            swapSourceDate.value = null;
            swapTargetDate.value = null;
            isMyHolidayMode.value = false;
        };

        const isSelected = (day) => selectedDates.value.includes(day.dateStr);
        const clearSelection = () => { selectedDates.value = []; };

        const openBulkModal = () => {
          isBulkEdit.value = true;
          holidayLabelInput.value = ''; 
          showModal.value = true;
        };
        
        const closeModal = () => { showModal.value = false; };

        const getOriginalType = (day) => {
           if (day.isWeekend) return '週末';
           if (day.publicHolidayName) return '祝日: ' + day.publicHolidayName;
           if (day.isCompanyHoliday) return '会社休';
           return '平日';
        };

        const setStatus = (type) => {
          let saveValue = type;
          if (type === 'HOLIDAY' && holidayLabelInput.value.trim() !== '') {
            saveValue = 'HOLIDAY:' + holidayLabelInput.value.trim();
          }

          let targets = [];
          if (isBulkEdit.value) {
            targets = [...selectedDates.value];
          } else {
            targets = [selectedDay.value.dateStr];
          }
          
          targets.forEach(dateStr => {
            dbData.value[dateStr] = saveValue;
          });
          
          saveStatusToDb(targets, saveValue);
          
          showModal.value = false;
          if (isBulkEdit.value) {
            selectedDates.value = [];
          }
        };

        onMounted(() => {
          loadAllData();
        });

        return {
          loading, errorMsg, year, month, calendarDays, stats, 
          changeMonth, getDayClass, getSelectionClass,
          showModal, selectedDay, handleDayClick, 
          isMultiSelectMode, selectedDates, isSelected, onModeChange, clearSelection, openBulkModal, closeModal, isBulkEdit,
          setStatus, getOriginalType, holidayLabelInput,
          isMyHolidayMode, swapSourceDate, swapTargetDate, showSwapConfirmModal, executeSwap
        };
      }
    }).mount('#app');
  </script>
</body>
</html>
